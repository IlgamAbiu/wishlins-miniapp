# Скрипты для деплоя

Этот проект включает набор скриптов для упрощения развертывания и управления приложением.

## Обзор скриптов

### 🚀 setup-server.sh

**Назначение**: Первоначальная настройка сервера

**Использование**:
```bash
./setup-server.sh user@server_ip
```

**Что делает**:
- Устанавливает Docker и Docker Compose
- Устанавливает Git, Nginx, Certbot
- Настраивает firewall (UFW)
- Создает директории для проекта

**Когда использовать**: Один раз при первой настройке нового сервера

---

### 📦 quick-start.sh

**Назначение**: Быстрый старт приложения на сервере

**Использование**:
```bash
# Запускать НА СЕРВЕРЕ после клонирования репозитория
cd ~/apps/wishlins-miniapp
./quick-start.sh
```

**Что делает**:
- Создает и помогает настроить .env файл
- Проверяет Docker установку
- Запускает контейнеры
- Выполняет миграции базы данных
- Проверяет работоспособность сервисов

**Когда использовать**: Один раз после клонирования репозитория на сервер

---

### 🔄 deploy.sh

**Назначение**: Автоматический деплой обновлений

**Использование**:
```bash
# Запускать С ЛОКАЛЬНОЙ МАШИНЫ
./deploy.sh user@server_ip
```

**Что делает**:
- Подключается к серверу по SSH
- Получает последние изменения из Git
- Пересобирает и перезапускает контейнеры
- Применяет новые миграции БД
- Проверяет статус

**Когда использовать**: Каждый раз когда нужно обновить приложение на сервере

---

### 🔍 check-status.sh

**Назначение**: Проверка состояния приложения

**Использование**:
```bash
# Локально
./check-status.sh

# Удаленно
./check-status.sh user@server_ip
```

**Что делает**:
- Показывает статус всех контейнеров
- Проверяет здоровье API
- Отображает последние логи
- Показывает использование ресурсов (для удаленной проверки)

**Когда использовать**: Для быстрой диагностики проблем или проверки работоспособности

---

### 🌐 generate-nginx-config.sh

**Назначение**: Генерация конфигурации Nginx

**Использование**:
```bash
./generate-nginx-config.sh your-domain.com
```

**Что делает**:
- Создает готовую конфигурацию Nginx для вашего домена
- Настраивает проксирование для frontend и backend
- Добавляет заголовки безопасности
- Выводит инструкции по установке

**Когда использовать**: После деплоя приложения, перед настройкой SSL

---

## Полный процесс деплоя

### Первоначальный деплой (один раз)

#### 1. Настройте сервер (с локальной машины):
```bash
./setup-server.sh user@server_ip
```

#### 2. Клонируйте репозиторий на сервер:
```bash
ssh user@server_ip
git clone <your-repo-url> ~/apps/wishlins-miniapp
cd ~/apps/wishlins-miniapp
```

#### 3. Запустите быстрый старт (на сервере):
```bash
./quick-start.sh
```

#### 4. Настройте Nginx (на сервере):
```bash
./generate-nginx-config.sh your-domain.com
# Следуйте инструкциям из вывода скрипта
```

#### 5. Установите SSL (на сервере):
```bash
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

### Обновление приложения (регулярно)

#### С локальной машины:
```bash
# После коммита изменений в Git
./deploy.sh user@server_ip
```

Или вручную на сервере:
```bash
ssh user@server_ip
cd ~/apps/wishlins-miniapp
git pull origin main
docker compose -f docker-compose.prod.yml up -d --build
docker compose -f docker-compose.prod.yml exec backend alembic upgrade head
```

### Проверка работоспособности

#### С локальной машины:
```bash
./check-status.sh user@server_ip
```

#### На сервере:
```bash
cd ~/apps/wishlins-miniapp
./check-status.sh
```

---

## Диаграмма процесса деплоя

```
┌─────────────────────────────────────────────────────────────┐
│                    Первоначальная настройка                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  ./setup-server.sh user@server_ip     │
        │  (устанавливает Docker, Nginx и т.д.) │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  ssh user@server_ip                   │
        │  git clone repo ~/apps/wishlins       │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  ./quick-start.sh                     │
        │  (настраивает .env, запускает)        │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  ./generate-nginx-config.sh domain    │
        │  sudo certbot --nginx                 │
        └───────────────────────────────────────┘
                            │
                            ▼
                    ✅ Деплой завершен

┌─────────────────────────────────────────────────────────────┐
│                    Обновление приложения                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  git commit && git push               │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  ./deploy.sh user@server_ip           │
        │  (автоматически обновляет)            │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  ./check-status.sh user@server_ip     │
        │  (проверяет работоспособность)        │
        └───────────────────────────────────────┘
                            │
                            ▼
                    ✅ Обновление завершено
```

---

## Требования к системе

### Локальная машина
- Bash (Linux, macOS) или WSL (Windows)
- SSH клиент
- Git

### Сервер
- Ubuntu 20.04+ (или другой Debian-based дистрибутив)
- Минимум 2GB RAM
- Минимум 20GB диск
- SSH доступ с sudo правами
- Открытые порты: 22 (SSH), 80 (HTTP), 443 (HTTPS)

---

## Полезные ссылки

- **[DEPLOYMENT.md](DEPLOYMENT.md)** - Полная документация по деплою
- **[CHEATSHEET.md](CHEATSHEET.md)** - Шпаргалка по командам
- **[README.md](README.md)** - Основная документация проекта

---

## Troubleshooting

### Скрипт не выполняется

```bash
# Убедитесь что скрипт исполняемый
chmod +x script-name.sh

# Запустите явно через bash
bash script-name.sh
```

### Проблемы с SSH

```bash
# Проверьте SSH подключение
ssh user@server_ip "echo 'Connection OK'"

# Добавьте ключ в ssh-agent если нужно
ssh-add ~/.ssh/id_rsa
```

### Ошибки Docker на сервере

```bash
# Проверьте что Docker запущен
sudo systemctl status docker

# Проверьте что пользователь в группе docker
groups

# Если нет, добавьте и перелогиньтесь
sudo usermod -aG docker $USER
```

---

## Примечания

- Все скрипты можно запускать многократно (идемпотентны)
- Скрипты проверяют предварительные условия перед выполнением
- Используйте `set -e` в скриптах для остановки при ошибках
- Все скрипты выводят цветные сообщения для лучшей читаемости

---

## Безопасность

- ⚠️ Никогда не коммитьте `.env` файлы в Git
- ⚠️ Используйте сильные пароли для PostgreSQL
- ⚠️ Ограничьте SSH доступ (используйте ключи, отключите пароли)
- ⚠️ Регулярно обновляйте систему: `sudo apt update && sudo apt upgrade`
- ⚠️ Настройте firewall правильно
- ✅ Всегда используйте HTTPS в production
- ✅ Делайте регулярные бэкапы базы данных
